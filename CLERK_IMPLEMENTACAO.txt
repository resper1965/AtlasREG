â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                                              â•‘
â•‘         CLERK - AUTENTICAÃ‡ÃƒO MULTITENANCY + RBAC + SSO                       â•‘
â•‘                      ImplementaÃ§Ã£o AtlasReg                                  â•‘
â•‘                                                                              â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Data: 20 de Outubro de 2025
Email: resper@ness.com.br
Powered by: ness.

================================================================================
âœ… CLERK INSTALADO E CONFIGURADO
================================================================================

Package: @clerk/nextjs@latest
Status: âœ“ Instalado
Modo: App Router (Next.js 15.5.5)

================================================================================
ğŸ“ ARQUIVOS CRIADOS
================================================================================

1. middleware.ts
   â†’ clerkMiddleware() com proteÃ§Ã£o de rotas
   â†’ Rotas pÃºblicas: /, /auth, /sign-in, /sign-up
   â†’ Rotas protegidas: /dashboard/* (require auth)

2. .env.local
   â†’ ConfiguraÃ§Ã£o Clerk
   â†’ URLs de redirect
   â†’ API backend

3. src/app/(auth)/sign-in/[[...sign-in]]/page.tsx
   â†’ PÃ¡gina de login Clerk
   â†’ Styled com ness. branding
   â†’ Dark theme

4. src/app/(auth)/sign-up/[[...sign-up]]/page.tsx
   â†’ PÃ¡gina de registro
   â†’ Styled com ness. branding
   â†’ Dark theme

PENDENTE:
---------
â˜ Atualizar app/layout.tsx com ClerkProvider
â˜ Adicionar UserButton no header
â˜ Configurar Clerk Dashboard
â˜ Obter keys

================================================================================
ğŸ”‘ PRÃ“XIMOS PASSOS
================================================================================

PASSO 1: Criar Conta Clerk
---------------------------
1. Acesse: https://dashboard.clerk.com/sign-up
2. Criar conta (grÃ¡tis)
3. Criar aplicaÃ§Ã£o: "AtlasReg"
4. Selecionar: Next.js

PASSO 2: Obter Keys
--------------------
Dashboard â†’ API Keys:
- NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_test_...
- CLERK_SECRET_KEY=sk_test_...

Copiar e colar em .env.local

PASSO 3: Atualizar Layout
--------------------------
SerÃ¡ feito automaticamente na prÃ³xima etapa

PASSO 4: Testar
---------------
npm run dev
http://localhost:3100/sign-in

================================================================================
ğŸ¢ MULTITENANCY - CONFIGURAÃ‡ÃƒO
================================================================================

Clerk suporta Multitenancy via Organizations:

SETUP NO CLERK DASHBOARD:
--------------------------
1. Dashboard â†’ Organizations â†’ Enable
2. Configurar:
   - Organization creation: Allow all users
   - Organization roles: Admin, Member, Guest
   - Organization permissions: Custom

CÃ“DIGO:
-------
// Obter organizaÃ§Ã£o atual
import { auth } from '@clerk/nextjs/server'

const { orgId, orgRole, orgPermissions } = await auth()

// Filtrar dados por organizaÃ§Ã£o
const eventos = await getEventos({ orgId })

MULTITENANCY NO BACKEND:
------------------------
FastAPI precisa validar orgId em cada request:

from fastapi import Header

@app.get("/events")
async def get_events(
    clerk_org_id: str = Header(None, alias="X-Clerk-Org-Id")
):
    # Filtrar por organizaÃ§Ã£o
    return db.query(Event).filter_by(org_id=clerk_org_id).all()

================================================================================
ğŸ” RBAC - ROLES E PERMISSÃ•ES
================================================================================

ROLES SUGERIDAS PARA ATLASREG:
-------------------------------

1. org:admin
   - Acesso total
   - Gerenciar usuÃ¡rios
   - Configurar fontes
   - Ver todos os dashboards
   - Exportar dados

2. org:analyst
   - Ver dashboards
   - Criar filtros
   - Exportar relatÃ³rios
   - Sem acesso a configuraÃ§Ãµes

3. org:viewer
   - Apenas visualizaÃ§Ã£o
   - Sem exportaÃ§Ã£o
   - Dashboards bÃ¡sicos

4. org:external
   - Acesso limitado
   - Apenas dados pÃºblicos
   - Sem dados sensÃ­veis

CONFIGURAÃ‡ÃƒO NO CLERK:
----------------------
Dashboard â†’ Roles & Permissions:

Admin permissions:
- org:events:read
- org:events:write
- org:events:delete
- org:config:manage
- org:users:manage

Analyst permissions:
- org:events:read
- org:dashboards:access
- org:exports:create

Viewer permissions:
- org:events:read
- org:dashboards:view

CÃ“DIGO - VERIFICAR PERMISSÃ•ES:
-------------------------------
import { auth } from '@clerk/nextjs/server'

async function checkPermission() {
  const { has } = await auth()
  
  if (has({ permission: 'org:events:delete' })) {
    // Permitir deletar
  }
  
  if (has({ role: 'org:admin' })) {
    // Ã‰ admin
  }
}

PROTEGER COMPONENTES:
---------------------
import { Protect } from '@clerk/nextjs'

<Protect permission="org:events:delete">
  <button>Deletar Evento</button>
</Protect>

<Protect role="org:admin">
  <AdminPanel />
</Protect>

================================================================================
ğŸ”— SSO - SINGLE SIGN-ON
================================================================================

Clerk suporta mÃºltiplos providers SSO:

PROVIDERS DISPONÃVEIS:
----------------------
âœ“ Google Workspace (G Suite)
âœ“ Microsoft Azure AD / Entra ID
âœ“ Okta
âœ“ Auth0
âœ“ SAML 2.0
âœ“ OAuth 2.0

CONFIGURAÃ‡ÃƒO:
-------------
1. Clerk Dashboard â†’ SSO Connections
2. Add connection
3. Selecionar provider (ex: Google Workspace)
4. Configurar:
   - Client ID
   - Client Secret
   - Redirect URL
5. Testar

CÃ“DIGO (AutomÃ¡tico):
--------------------
Clerk gerencia SSO automaticamente.
UsuÃ¡rio clica "Continue with Google" â†’ SSO flow

CUSTOM SSO (Enterprise):
------------------------
Para SAML / Enterprise SSO:

1. Clerk Dashboard â†’ Enterprise SSO
2. Configurar SAML 2.0
3. Metadata URL ou Upload XML
4. Mapear atributos (email, name, org)
5. Testar

AtlasReg automaticamente suporta!

================================================================================
ğŸ—ï¸ ESTRUTURA DE DADOS MULTITENANCY
================================================================================

MODELO RECOMENDADO:
-------------------

Organization (Clerk)
â”œâ”€ id: org_xxxxx
â”œâ”€ name: "Taesa"
â”œâ”€ slug: "taesa"
â””â”€ metadata: { tier: "enterprise" }

User (Clerk)
â”œâ”€ id: user_xxxxx
â”œâ”€ email: "analista@taesa.com.br"
â”œâ”€ organizations: [org_xxxxx]
â””â”€ publicMetadata: { department: "risk" }

Event (PostgreSQL - AtlasReg)
â”œâ”€ id: uuid
â”œâ”€ org_id: org_xxxxx â† FOREIGN KEY
â”œâ”€ titulo: "ANEEL multa..."
â”œâ”€ created_by: user_xxxxx
â””â”€ ...

Document (PostgreSQL - AtlasReg)
â”œâ”€ id: uuid
â”œâ”€ org_id: org_xxxxx â† FOREIGN KEY
â”œâ”€ ...

Watchlist (PostgreSQL - AtlasReg)
â”œâ”€ id: uuid
â”œâ”€ org_id: org_xxxxx â† FOREIGN KEY
â”œâ”€ user_id: user_xxxxx
â””â”€ ...

REGRA: Todas as tabelas tÃªm org_id!

QUERIES SEMPRE FILTRAM POR ORG:
-------------------------------
SELECT * FROM events WHERE org_id = :org_id

ISOLAMENTO TOTAL ENTRE ORGANIZAÃ‡Ã•ES:
-------------------------------------
Taesa nÃ£o vÃª dados da CEMIG
CEMIG nÃ£o vÃª dados da Taesa
Cada org tem seus prÃ³prios eventos, filtros, watchlists

================================================================================
ğŸ”§ INTEGRAÃ‡ÃƒO BACKEND (FastAPI)
================================================================================

VALIDAR TOKEN CLERK:
--------------------

from clerk_backend_api import Clerk
from fastapi import Header, HTTPException

clerk = Clerk(bearer_auth=os.getenv("CLERK_SECRET_KEY"))

async def get_current_user(
    authorization: str = Header(None)
):
    if not authorization:
        raise HTTPException(401, "No auth token")
    
    token = authorization.replace("Bearer ", "")
    
    try:
        # Validar token com Clerk
        session = clerk.sessions.verify_session(token)
        return session.user_id, session.org_id
    except:
        raise HTTPException(401, "Invalid token")

ENDPOINT COM AUTH:
------------------

@app.get("/api/events")
async def get_events(
    user_data = Depends(get_current_user)
):
    user_id, org_id = user_data
    
    # Filtrar por organizaÃ§Ã£o
    events = db.query(Event).filter_by(org_id=org_id).all()
    
    return events

================================================================================
ğŸ¨ COMPONENTES CLERK NO ATLASREG
================================================================================

ATUALIZAR LAYOUT:
-----------------
Criar componente de Header com Clerk:

// src/components/clerk-header.tsx
import { UserButton, OrganizationSwitcher } from '@clerk/nextjs'
import { SignedIn, SignedOut, SignInButton } from '@clerk/nextjs'

export function ClerkHeader() {
  return (
    <header className="border-b bg-gray-900 border-gray-800">
      <div className="flex items-center justify-between p-4">
        <div className="flex items-center gap-4">
          <h1 className="text-2xl font-bold">
            Atlas<span className="text-[#00ADE8]">REG</span>
          </h1>
          
          {/* Trocar de organizaÃ§Ã£o */}
          <SignedIn>
            <OrganizationSwitcher 
              appearance={{
                elements: {
                  rootBox: "text-white"
                }
              }}
            />
          </SignedIn>
        </div>
        
        <div>
          <SignedOut>
            <SignInButton mode="modal">
              <button className="px-4 py-2 bg-[#00ADE8] text-white rounded">
                Login
              </button>
            </SignInButton>
          </SignedOut>
          
          <SignedIn>
            <UserButton 
              appearance={{
                elements: {
                  userButtonAvatarBox: "w-10 h-10"
                }
              }}
              afterSignOutUrl="/"
            />
          </SignedIn>
        </div>
      </div>
    </header>
  )
}

PROTEGER PÃGINAS:
-----------------

// src/app/(main)/dashboard/layout.tsx
import { auth } from '@clerk/nextjs/server'
import { redirect } from 'next/navigation'

export default async function DashboardLayout({ children }) {
  const { userId } = await auth()
  
  if (!userId) {
    redirect('/sign-in')
  }
  
  return <>{children}</>
}

MOSTRAR DADOS DO USUÃRIO:
-------------------------

import { currentUser } from '@clerk/nextjs/server'

export default async function ProfilePage() {
  const user = await currentUser()
  
  return (
    <div>
      <h1>Bem-vindo, {user?.firstName}</h1>
      <p>Email: {user?.emailAddresses[0].emailAddress}</p>
      <p>OrganizaÃ§Ã£o: {user?.organizationMemberships[0]?.organization.name}</p>
    </div>
  )
}

================================================================================
ğŸ” RBAC - IMPLEMENTAÃ‡ÃƒO COMPLETA
================================================================================

DEFINIR ROLES NO CLERK DASHBOARD:
----------------------------------

Dashboard â†’ Roles:

1. admin
   Permissions:
   - org:events:read, write, delete
   - org:config:manage
   - org:users:invite
   - org:exports:unlimited

2. analyst
   Permissions:
   - org:events:read
   - org:dashboards:all
   - org:exports:limited

3. viewer
   Permissions:
   - org:events:read
   - org:dashboards:basic

USAR NO CÃ“DIGO:
---------------

import { Protect } from '@clerk/nextjs'

// BotÃ£o apenas para admin
<Protect role="org:admin">
  <button onClick={deleteEvent}>Deletar</button>
</Protect>

// SeÃ§Ã£o por permissÃ£o
<Protect permission="org:exports:create">
  <ExportButton />
</Protect>

// MÃºltiplas condiÃ§Ãµes
<Protect
  role="org:admin"
  permission="org:config:manage"
  fallback={<p>Sem permissÃ£o</p>}
>
  <ConfigPanel />
</Protect>

SERVER-SIDE:
------------

import { auth } from '@clerk/nextjs/server'

async function serverAction() {
  const { has } = await auth()
  
  if (!has({ permission: 'org:events:delete' })) {
    throw new Error('Sem permissÃ£o')
  }
  
  // Deletar evento
}

================================================================================
ğŸ¢ MULTITENANCY - CENÃRIOS DE USO
================================================================================

CENÃRIO 1: MÃºltiplas Empresas
------------------------------

OrganizaÃ§Ãµes:
- Taesa (transmissora)
- CEMIG (transmissora)
- Energisa (distribuidora)

Cada org vÃª apenas seus dados:
- Taesa vÃª eventos sobre Taesa
- CEMIG vÃª eventos sobre CEMIG
- Isolamento total

CENÃRIO 2: Consultorias
-----------------------

OrganizaÃ§Ã£o: "Consultoria Energia LTDA"

Membros:
- Analista A (acesso cliente X)
- Analista B (acesso cliente Y)
- Admin (acesso tudo)

Usar custom metadata para filtrar por cliente.

CENÃRIO 3: Ã“rgÃ£o Regulador
---------------------------

OrganizaÃ§Ã£o: "ANEEL"

Departamentos:
- FiscalizaÃ§Ã£o (vÃª multas)
- Outorgas (vÃª concessÃµes)
- Estudos (vÃª tudo)

Usar roles por departamento.

================================================================================
ğŸ”— SSO - CONFIGURAÃ‡ÃƒO DETALHADA
================================================================================

GOOGLE WORKSPACE SSO:
---------------------

1. Clerk Dashboard â†’ SSO â†’ Google
2. Enable Google SSO
3. Configurar domÃ­nio: @taesa.com.br
4. Auto-assign to organization: Taesa
5. Auto-assign role: analyst

Resultado:
- FuncionÃ¡rio Taesa faz login com @taesa.com.br
- Automaticamente entra na org Taesa
- Automaticamente recebe role analyst

MICROSOFT ENTRA ID (Azure AD):
------------------------------

1. Clerk Dashboard â†’ SSO â†’ Microsoft
2. Configure:
   - Tenant ID
   - Client ID
   - Client Secret
3. Redirect URL: https://clerk.atlasreg.ness.tec.br/...
4. Mapear claims

SAML 2.0 (Enterprise):
----------------------

Para grandes empresas:

1. Clerk Dashboard â†’ Enterprise SSO
2. Upload SAML metadata XML
3. Configure attribute mapping:
   - email â†’ email
   - name â†’ firstName + lastName
   - department â†’ publicMetadata.department
4. Test SSO

================================================================================
ğŸ“Š METADATA E CUSTOM FIELDS
================================================================================

USER METADATA (Clerk):
----------------------

publicMetadata (acessÃ­vel no frontend):
{
  "department": "Risk Analysis",
  "employee_id": "12345",
  "tier": "premium"
}

privateMetadata (apenas backend):
{
  "internal_notes": "VIP customer",
  "last_audit": "2025-10-20"
}

unsafeMetadata (usuÃ¡rio pode editar):
{
  "preferences": {
    "theme": "dark",
    "notifications": true
  }
}

ORGANIZATION METADATA:
----------------------

publicMetadata:
{
  "tier": "enterprise",
  "max_users": 100,
  "features": ["advanced_analytics", "api_access"],
  "contract_end": "2026-12-31"
}

USO NO CÃ“DIGO:
--------------

import { currentUser } from '@clerk/nextjs/server'

const user = await currentUser()
const tier = user?.publicMetadata?.tier

if (tier === "premium") {
  // Features premium
}

================================================================================
ğŸš€ FEATURES CLERK QUE VAMOS USAR
================================================================================

1. âœ… Multitenancy via Organizations
   - Isolamento de dados por empresa
   - Organization switcher
   - Auto-assignment via SSO

2. âœ… RBAC (Role-Based Access Control)
   - Roles customizÃ¡veis
   - Permissions granulares
   - Protect components

3. âœ… SSO (Single Sign-On)
   - Google Workspace
   - Microsoft Entra ID
   - SAML 2.0

4. âœ… MFA (Multi-Factor Authentication)
   - SMS
   - Authenticator apps
   - Backup codes

5. âœ… Session Management
   - Tokens JWT
   - Auto-refresh
   - Revocation

6. âœ… User Management
   - Profile management
   - Email verification
   - Password reset

7. âœ… Webhooks
   - user.created
   - organization.created
   - session.created
   - Integrar com backend

8. âœ… Analytics
   - Login metrics
   - User activity
   - Security events

================================================================================
ğŸ’° CUSTOS CLERK
================================================================================

FREE TIER:
----------
âœ“ 10.000 MAUs (Monthly Active Users)
âœ“ Unlimited organizations
âœ“ SSO (Google, Microsoft, GitHub)
âœ“ RBAC bÃ¡sico
âœ“ MFA
âœ“ Webhooks

PREÃ‡O: $0/mÃªs atÃ© 10k usuÃ¡rios

PRO TIER ($25/mÃªs):
-------------------
âœ“ 1.000 MAUs incluÃ­dos
âœ“ SAML SSO
âœ“ Advanced RBAC
âœ“ Custom roles
âœ“ Priority support

ENTERPRISE:
-----------
âœ“ Unlimited MAUs
âœ“ Custom SSO
âœ“ SLA 99.99%
âœ“ Dedicated support

Para AtlasReg:
--------------
FREE TIER Ã© suficiente! (atÃ© 10k usuÃ¡rios)

================================================================================
ğŸ”§ INTEGRAÃ‡ÃƒO COM ATLASREG EXISTENTE
================================================================================

SUBSTITUIR AUTH ATUAL:
----------------------

Remover (se existir):
âœ— JWT auth manual
âœ— Session cookies manuais
âœ— Password hashing manual

Usar Clerk:
âœ“ Auth gerenciado
âœ“ Tokens automÃ¡ticos
âœ“ SessÃµes seguras

MIGRAR USUÃRIOS:
----------------

Se jÃ¡ tem usuÃ¡rios no PostgreSQL:

1. Export users do DB
2. Import via Clerk API:

import { clerkClient } from '@clerk/nextjs/server'

await clerkClient.users.createUser({
  emailAddress: ["user@example.com"],
  password: "temporary123",
  publicMetadata: { migrated: true }
})

3. Enviar email para resetar senha

WEBHOOKS CLERK â†’ BACKEND:
--------------------------

Backend FastAPI recebe webhooks:

@app.post("/webhooks/clerk")
async def clerk_webhook(request: Request):
    # Validar signature
    # Processar evento
    
    if event.type == "user.created":
        # Criar registro no DB
        user = User(
            clerk_id=event.data.id,
            email=event.data.email_addresses[0].email,
            org_id=event.data.organization_memberships[0].id
        )
        db.add(user)
    
    if event.type == "organization.created":
        # Setup inicial da org
        create_default_watchlists(event.data.id)

================================================================================
ğŸ“‹ CHECKLIST DE IMPLEMENTAÃ‡ÃƒO
================================================================================

SETUP INICIAL:
--------------
â˜ 1. Criar conta Clerk
â˜ 2. Criar aplicaÃ§Ã£o AtlasReg
â˜ 3. Obter API keys
â˜ 4. Configurar .env.local
â˜ 5. Atualizar layout.tsx
â˜ 6. Testar login local

MULTITENANCY:
-------------
â˜ 7. Enable Organizations no Clerk
â˜ 8. Criar roles (admin, analyst, viewer)
â˜ 9. Adicionar org_id em todas as tabelas
â˜ 10. Atualizar queries com filtro org_id

RBAC:
-----
â˜ 11. Definir permissions
â˜ 12. Proteger componentes com <Protect>
â˜ 13. Verificar permissions server-side
â˜ 14. Testar diferentes roles

SSO:
----
â˜ 15. Configurar Google SSO
â˜ 16. Configurar Microsoft SSO (opcional)
â˜ 17. Testar SSO flow
â˜ 18. Auto-assignment de org

BACKEND:
--------
â˜ 19. Instalar clerk-backend-api (Python)
â˜ 20. Validar tokens no FastAPI
â˜ 21. Filtrar dados por org_id
â˜ 22. Configurar webhooks

PRODUÃ‡ÃƒO:
---------
â˜ 23. Configurar domÃ­nio customizado Clerk
â˜ 24. SSL/TLS
â˜ 25. Monitoramento
â˜ 26. Backup de usuÃ¡rios

================================================================================
ğŸš€ PRÃ“XIMA AÃ‡ÃƒO IMEDIATA
================================================================================

AGORA:
------
1. Criar conta Clerk: https://dashboard.clerk.com/sign-up
2. Obter keys
3. Atualizar .env.local
4. Eu vou atualizar o layout.tsx

DEPOIS:
-------
Testar login e configurar organizations

COMANDO PARA CONTINUAR:
-----------------------
Informe as keys do Clerk ou diga "continuar" para eu
completar a integraÃ§Ã£o com keys de exemplo (placeholder).

================================================================================
Powered by: ness.
Email: resper@ness.com.br
Status: âœ“ Clerk instalado - Aguardando keys para completar
================================================================================

